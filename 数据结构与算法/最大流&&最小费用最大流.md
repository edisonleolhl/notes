# 最大流&&最小费用最大流

## 最大流问题

- 比喻：有一个自来水管道运输系统，起点是 s，终点是 t，途中经过的管道都有一个最大的容量，可以想象每条管道不能被水流“撑爆”。求从 s 到 t 的最大水流量是多少？

- 应用：网络最大流问题是网络的另一个基本问题。许多系统包含了流量问题。例如交通系统有车流量，金融系统有现金流，控制系统有信息流等。许多流问题主要是确定这类系统网络所能承受的最大流量以及如何达到这个最大流量。

- 流网络（Flow Networks）：指的是一个有向图 G = (V, E)，其中每条边 (u, v) ∈ E 均有一非负容量 c(u, v) ≥ 0。如果 (u, v) ∉ E 则可以规定 c(u, v) = 0。流网络中有两个特殊的顶点：源点 s （source）和汇点 t（sink）。为方便起见，假定每个顶点均处于从源点到汇点的某条路径上，就是说，对每个顶点 v ∈ E，存在一条路径 s --> v --> t。

- Ford-Fulkerson 算法

  - 残留网络(residual capacity)：容量网络 - 流量网络 = 残留网络
    > 具体说来，就是假定一个网络 G =（V，E），其源点 s，汇点 t。设 f 为 G 中的一个流，对应顶点 u 到顶点 v 的流。在不超过 C（u，v）的条件下（C 代表边容量），从 u 到 v 之间可以压入的额外网络流量，就是边（u，v）的残余容量（residual capacity）。

  - 增广路径(augmenting path): 这是一条不超过各边容量的简单路径，向这个路径注入流量，可以增加整个网络的流量。

  - 割：用来证明  “当残留网络中找不到增广路径时，即找到最大流”，具体证明略。

  - 伪代码：

        FORD-FULKERSON（G，t，s）

        1 for each edge(u,v) 属于 E（G）

        2     do f[u,v]=0

        3          f[v,u]=0

        4 while there exists a path p from s to t in the residual network Gf //可以使用 BFS 搜索增广路径，这时变为 Edmond-Karp 算法

        5       do cf(p)=min{cf(u,v):(u,v)is in p}  //在这条路径中寻找最小边剩余流量

        6        for each edge (u,v) in p

        7              do f[u,v]=f[u,v]+cf(p)  //该路径中的每条边中注入刚才找到到的最小剩余流量

        8                    f[v,u]=-f[u,v]   //反向边注入反向流量

  - 反向边是什么？

    > 转自：http://nano9th.wordpress.com.cn/2009/02/17/%E7%BD%91%E7%BB%9C%E6%B5%81%E5%9F%BA%E7%A1%80%E7%AF%87-edmond-karp%E7%AE%97%E6%B3%95/

    - 假设没有上面伪代码中最后一步的操作，那么对于如下的流网络：

        ![](http://hiphotos.baidu.com/scaneelingg/pic/item/41bd4fca9e4d1d36be09e6ca.jpg?_=3061893)

    - 我们第一次找到了 1-2-3-4 这条增广路，这条路上的最小边剩余流量显然是 1。于是我们修改后得到了下面这个残留网络：

        ![](http://hiphotos.baidu.com/scaneelingg/pic/item/60535f619638686debf8f8ca.jpg?_=3061893)

    - 这时候 (1,2) 和 (3,4) 边上的流量都等于容量了，我们再也找不到其他的增广路了，当前的流量是 1。但这个答案明显不是最大流，因为我们可以同时走 1-2-4 和 1-3-4，这样可以得到流量为 2 的流。

    - 而这个算法神奇的利用了一个叫做反向边的概念来解决这个问题。即每条边 (I,j) 都有一条反向边 (j,i)，反向边也同样有它的容量。那么我们刚刚的算法问题在哪里呢？问题就在于我们没有给程序一个” 后悔” 的机会，应该有一个不走 (2-3-4) 而改走 (2-4) 的机制。

    - 我们来看刚才的例子，在找到 1-2-3-4 这条增广路之后，把容量修改成如下:

        ![](http://hiphotos.baidu.com/scaneelingg/pic/item/2f767e91a00f9ca4a977a4cb.jpg?_=3061893)

    - 这时再找增广路的时候，就会找到 1-3-2-4 这条可增广量，即 delta 值为 1 的可增广路。将这条路增广之后，得到了最大流 2。

        ![](http://hiphotos.baidu.com/scaneelingg/pic/item/6074478cf17bd63bb31bbacb.jpg?_=3061893)

    - 解释：

      事实上，当我们第二次的增广路走 3-2 这条反向边的时候，就相当于把 2-3 这条正向边已经是用了的流量给” 退” 了回去，不走 2-3 这条路，而改走从 2 点出发的其他的路也就是 2-4。（有人问如果这里没有 2-4 怎么办，这时假如没有 2-4 这条路的话，最终这条增广路也不会存在，因为他根本不能走到汇点）同时本来在 3-4 上的流量由 1-3-4 这条路来” 接管”。而最终 2-3 这条路正向流量 1，反向流量 1，等于没有流量。

    - 这就是这个算法的精华部分，利用反向边，使程序有了一个后悔和改正的机会。

### 最大流实例：

- 对于如下拓扑图，给出从S1到S6允许的流的方向和带宽限制：

  - 求出S1到S6最大可能带宽（提示Ford-Fulkerson算法）。

  - 画出流的流向及带宽分配，使达到最大可能的带宽。

    ![201798-maxflow](http://ooy7h5h7x.bkt.clouddn.com/blog/image/201798-maxflow.png)

## 最小费用最大流

- 最小费用最大流问题是经济学和管理学中的一类典型问题。在一个网络中每段路径都有 “容量” 和 “费用” 两个限制的条件下，此类问题的研究试图寻找出：流量从 A 到 B，如何选择路径、分配经过路径的流量，可以在流量最大的前提下，达到所用的费用最小的要求。如 n 辆卡车要运送物品，从 A 地到 B 地。由于每条路段都有不同的路费要缴纳，每条路能容纳的车的数量有限制，最小费用最大流问题指如何分配卡车的出发路径可以达到费用最低，物品又能全部送到。

- 注意：最后得到的流必须是最大流，最大流可能有多种情况，目标是找出最小费用的那种情况。

- 解决最小费用最大流问题，一般有两条途径。

  - 一条途径是先用最大流算法算出最大流，然后根据边费用，检查是否有可能在流量平衡的前提下通过调整边流量，使总费用得以减少？只要有这个可能，就进行这样的调整。调整后，得到一个新的最大流。然后，在这个新流的基础上继续检查，调整。这样迭代下去，直至无调整可能，便得到最小费用最大流。这一思路的特点是保持问题的可行性（始终保持最大流），向最优推进。

  - 另一条解决途径和前面介绍的最大流算法思路相类似，一般首先给出零流作为初始流。这个流的费用为零，当然是最小费用的。然后寻找一条源点至汇点的增流链，但要求这条增流链必须是所有增流链中费用最小的一条。如果能找出增流链，则在增流链上增流，得出新流。将这个流做为初始流看待，继续寻找增流链增流。这样迭代下去，直至找不出增流链，这时的流即为最小费用最大流。这一算法思路的特点是保持解的最优性（每次得到的新流都是费用最小的流），而逐渐向可行解靠近（直至最大流时才是一个可行解）。

### 最小费用最大流实例：

- 对于如下拓扑图，给出从S1到S6允许的流的方向和带宽限制，链路按带宽收费，以括号形式表示为（带宽容量，单位带宽费用）：

  - 求出S1到S6最小费用下最大可能带宽，得出最小费用值，并标出选路状况。

  - 写出对给出任意拓扑图的通用算法描述。

    ![201798-mincostmaxflow](http://ooy7h5h7x.bkt.clouddn.com/blog/image/201798-mincostmaxflow.png)